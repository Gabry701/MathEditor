const inlineMath=document.querySelector(".math-inline"),blockMath=document.querySelector(".math-block"),writableCanvas=document.querySelector(".write"),displayCanvas=document.querySelector(".display"),buttons=document.getElementsByClassName("math-button"),hide=document.querySelector(".hide-button"),buttonsSection=document.querySelector(".buttons"),minimizedButtons=document.querySelector(".minimized-buttons"),maxButton=document.querySelector(".maximise"),quitPreviewButton=document.querySelector(".quit-preview-button"),AddMathButton=document.querySelector(".add-math-button"),newLineButton=document.querySelector(".newline"),showButton=document.querySelector(".show-buttons"),minMaxButton=document.querySelector(".min-preview"),saveButton=document.querySelector(".save-button"),minSaveButton=document.querySelector(".min-save"),bold=document.querySelector(".bold"),italic=document.querySelector(".italic"),underline=document.querySelector(".underline"),maximiseButtons=[maxButton,minMaxButton],formatButtons=[bold,italic,underline],saveButtons=[saveButton,minSaveButton],inlineChar="$",blockChar="$$";let currentChar="$",isActive=!1,activatedButtons=[],cursorElement;const symbols={"not-equals":"\\neq ",multiply:"\\times ",divide:"\\div ","plus-minus":"\\pm ","dot-product":"\\cdot ",frac:"\\frac{}{}",sqrt:"\\sqrt{}","nth-root":"\\sqrt[]{}",square:"^2 ",power:"^{}",log:"\\log_{}{}",ln:"\\ln{}",union:"\\cup ",abs:"|{}|",percent:"\\% ",intersection:"\\cap ",inf:"\\infty ",deg:"\xb0 ",sin:"\\sin{}",cos:"\\cos{}",tan:"\\tan{}",csc:"\\csc{}",sec:"\\sec{}",cot:"\\cot{}",asin:"\\arcsin{}",acos:"\\arccos{}",atan:"\\arctan{}",sinh:"\\sinh{}",cosh:"\\cosh{}",tanh:"\\tanh{}",pi:"\\pi ",tau:"\\tau ",alpha:"\\alpha ",beta:"\\beta ",gamma:"\\gamma ",delta:"\\delta ",Delta:"\\Delta ",theta:"\\theta ",mu:"\\mu ",epsilon:"\\varepsilon ",lambda:"\\lambda ",rho:"\\rho ",sigma:"\\sigma ",ell:"\\ell ",phi:"\\Phi ",omega:"\\omega ",Gamma:"\\Gamma ",Omega:"\\Omega ",system:"\\begin{cases} \n {} \\\\ \n {} \n\\end{cases}",sum:"\\sum_{=}^{}",product:"\\prod_{=}^{}",limit:"\\lim_{x \\to {}}",derivative:"\\frac{d}{dx} ","partial-derivative":"\\frac{\\partial}{\\partial x} ",integral:"\\int ","definite-integral":"\\int_{}^{}","double-integral":"\\iint ","triple-integral":"\\iiint ",nabla:"\\nabla ","contour-integral":"\\oint ",scientific:"10^{}",sub:"_{}","vector-a":"\\vec{}",implies:"\\Rightarrow ",in:"\\in ","not-in":"\\notin ",subset:"\\subset ",superset:"\\supset ",exists:"\\exists ","not-exists":"\\nexists ",forall:"\\forall ",negation:"\\neg ",and:"\\land ",or:"\\lor ",iff:"\\Leftrightarrow ",angle:"\\angle ","right-angle":"\\angle ",choose:"{}\\choose{}",perpendicular:"\\perp ",parallel:"\\parallel ",congruent:"\\equiv ",similar:"\\sim ","segment-ab":"\\overline{}","angle-ab":"\\widehat{}",naturals:"\\mathbb{N} ",integers:"\\mathbb{Z} ",rationals:"\\mathbb{Q} ",real:"\\mathbb{R} ",complex:"\\mathbb{C} ",empty:"\\varnothing "};function isInsideMath(e){if(e.length>0){let t=e.split(""),n=0;for(let a=0;a<t.length;a++)"$"==t[a]&&"$"!=t[a-1]&&(n+=1);return n%2}return!1}function getCanvasValues(){let e=cursorElement.selectionStart,t=cursorElement.selectionEnd,n=cursorElement.value;return[e,n.substring(0,e),n.substring(t)]}function calculateCursorOffset(e){return e.includes("begin")||e.includes("lim")?e.indexOf("{",10)+1:e.includes("<>")?e.length:e.includes("  ")?e.lastIndexOf(" "):e.indexOf(" ",3)!=-1?e.indexOf(" ",e.length-4)+1:e.indexOf("{")+1}function insertNewLine(e,t){let n,a,l=void 0!=cursorElement?cursorElement:writableCanvas,r=" \\\\\n   ";if(e.includes("begin{align}"))l.value=e+r+t,a=e.length+r.length;else{let s=e.lastIndexOf("$"),o=t.indexOf("$"),c=`${e.substring(0,s+1)}\\begin{align}
   ${e.substring(s+1,e.length-1)}`;-1!=o&&(n=`
\\end{align}${t.substring(o)}`),l.value=c+r+n,a=c.length+r.length}l.focus(),l.setSelectionRange(a,a)}function addToTextArea(e,t=null,n=!1){let[a,l,r]=getCanvasValues(),s=isInsideMath(l),o=s&&null!=t?t:e;if(void 0!=cursorElement){if("newLine"==o){insertNewLine(l,r);return}l.length>0&&!["\n"," ","{"].includes(l[l.length-1])&&(o=" "+o);let c=a+calculateCursorOffset(o);cursorElement.value=l+o+r,cursorElement.focus(),cursorElement.setSelectionRange(c,c)}else writableCanvas.innerHTML=writableCanvas.innerHTML+o,writableCanvas.focus(),writableCanvas.setSelectionRange(writableCanvas.innerHTML.length)}blockMath.addEventListener("click",()=>{blockMath.style.backgroundColor="var(--azure)",inlineMath.style.backgroundColor="var(--light-cyan)",currentChar="$$"}),inlineMath.addEventListener("click",()=>{inlineMath.style.backgroundColor="var(--azure)",blockMath.style.backgroundColor="var(--light-cyan)",currentChar="$"}),document.addEventListener("focusin",function(e){"textarea"===e.target.tagName.toLowerCase()&&(cursorElement=e.target)});for(let i=0;i<buttons.length;i++)buttons[i].addEventListener("click",function(){let e=symbols[buttons[i].id];addToTextArea(`${currentChar}${e}${currentChar}`,e)});hide.addEventListener("click",()=>{buttonsSection.classList.add("hidden"),minimizedButtons.classList.remove("hidden"),displayCanvas.classList.add("auto-height"),writableCanvas.classList.add("auto-height")}),showButton.addEventListener("click",()=>{buttonsSection.classList.remove("hidden"),minimizedButtons.classList.add("hidden"),displayCanvas.classList.remove("auto-height"),writableCanvas.classList.remove("auto-height")}),maximiseButtons.forEach(e=>{e.addEventListener("click",()=>{displayCanvas.classList.add("maxed"),quitPreviewButton.classList.remove("hidden")})}),quitPreviewButton.addEventListener("click",()=>{displayCanvas.classList.remove("maxed"),quitPreviewButton.classList.add("hidden")}),AddMathButton.addEventListener("click",()=>{addToTextArea(`${currentChar}  ${currentChar}`,"")});let timeout,cleanedValue="";["focus","input"].forEach(e=>{writableCanvas.addEventListener(e,()=>{clearTimeout(timeout),timeout=setTimeout(()=>{cleanedValue=writableCanvas.value.replaceAll("\n","").replaceAll(" <>","\n").replaceAll("/B/","<b>").replaceAll("/I/","<i>").replaceAll("/U/","<u>").replaceAll("\\B\\","</b>").replaceAll("\\I\\","</i>").replaceAll("\\U\\","</u>"),displayCanvas.innerHTML=cleanedValue,MathJax.typesetPromise([displayCanvas])},100)})}),writableCanvas.addEventListener("keydown",function(e){"Enter"===e.key&&e.getModifierState("Control")&&addToTextArea(" <>\n","newLine")}),newLineButton.addEventListener("click",function(e){addToTextArea(" <>\n","newLine")}),formatButtons.forEach(e=>{e.addEventListener("click",function(t){addToTextArea(`/${e.textContent}/  \\${e.textContent}\\`)})}),saveButtons.forEach(e=>{e.addEventListener("click",()=>{let e=prompt("Inserire il nome del file: ")+".txt";if("null.txt"!=e){let t=new Blob([cleanedValue],{type:"text/plain"}),n=URL.createObjectURL(t),a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",e),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}})});
